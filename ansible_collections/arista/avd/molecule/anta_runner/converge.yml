---
- name: Converge
  hosts: FABRIC
  gather_facts: false
  vars:
    root_dir: "{{ playbook_dir }}"
  tasks:
    - name: Generate AVD Structured Configurations and Fabric Documentation
      ansible.builtin.import_role:
        name: arista.avd.eos_designs

    - name: ANTA Default Run
      delegate_to: 127.0.0.1
      ansible.builtin.import_role:
        name: arista.avd.anta_runner
      vars:
        anta_runner_dry_run: true
        avd_catalogs_dir: "{{ root_dir }}/anta/avd_catalogs/default_run"
        anta_reports_dir: "{{ root_dir }}/anta/reports/default_run"
      run_once: true

    - name: ANTA Allow BGP VRFs Run
      delegate_to: 127.0.0.1
      ansible.builtin.import_role:
        name: arista.avd.anta_runner
      vars:
        anta_runner_dry_run: true
        avd_catalogs_dir: "{{ root_dir }}/anta/avd_catalogs/allow_bgp_vrfs_run"
        anta_reports_dir: "{{ root_dir }}/anta/reports/allow_bgp_vrfs_run"
        avd_catalogs_allow_bgp_vrfs: true
      run_once: true

    - name: ANTA Filtered Run
      delegate_to: 127.0.0.1
      ansible.builtin.import_role:
        name: arista.avd.anta_runner
      vars:
        anta_runner_dry_run: true
        avd_catalogs_dir: "{{ root_dir }}/anta/avd_catalogs/filtered_run"
        anta_reports_dir: "{{ root_dir }}/anta/reports/filtered_run"
        # When a device is part of multiple filters, the last filter will be applied so the order is important
        avd_catalogs_filters:
          # Skip VerifyNTP for all fabric devices
          - device_list: "{{ groups['FABRIC'] }}"
            skip_tests:
              - VerifyNTP
          # Only VerifyReachability will run on DC1_SVC_LEAVES devices
          - device_list: "{{ groups['DC1_SVC_LEAVES'] }}"
            run_tests:
              - VerifyReachability
          # Skip tests take precedence over run_tests
          # All tests except VerifyLLDPNeighbors will run on DC2_SPINES devices
          - device_list: "{{ groups['DC2_SPINES'] }}"
            run_tests:
              - VerifyLLDPNeighbors
            skip_tests:
              - VerifyLLDPNeighbors

    - name: ANTA User-Defined Catalogs Run
      delegate_to: 127.0.0.1
      ansible.builtin.import_role:
        name: arista.avd.anta_runner
      vars:
        anta_runner_dry_run: true
        avd_catalogs_enabled: false
        anta_reports_dir: "{{ root_dir }}/anta/reports/user_defined_catalogs_run"

    - name: ANTA User-Defined Catalogs Run with Tags
      delegate_to: 127.0.0.1
      ansible.builtin.import_role:
        name: arista.avd.anta_runner
      vars:
        anta_runner_dry_run: true
        avd_catalogs_enabled: false
        anta_reports_dir: "{{ root_dir }}/anta/reports/user_defined_catalogs_with_tags_run"
        anta_runner_tags: ["border_leaf"]
