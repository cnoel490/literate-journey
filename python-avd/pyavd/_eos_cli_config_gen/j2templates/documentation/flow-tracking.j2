{#
 Copyright (c) 2023-2025 Arista Networks, Inc.
 Use of this source code is governed by the Apache License 2.0
 that can be found in the LICENSE file.
#}
{# doc - flow tracking #}
{% if flow_tracking is arista.avd.defined %}

### Flow Tracking
{%     if flow_tracking.sampled is arista.avd.defined %}

#### Flow Tracking Sampled

| Sample Size | Minimum Sample Size | Hardware Offload for IPv4 | Hardware Offload for IPv6 | Encapsulations |
| ----------- | ------------------- | ------------------------- | ------------------------- | -------------- |
{%         set sample_size = flow_tracking.sampled.sample | arista.avd.default("default") %}
{%         set min_sample_size = flow_tracking.sampled.hardware_offload.threshold_minimum | arista.avd.default("default") %}
{%         set hardware_offload_ipv4 = 'disabled' %}
{%         set hardware_offload_ipv6 = 'disabled' %}
{%         set encapsulations_list = [] %}
{%         if flow_tracking.sampled.encapsulation.ipv4_ipv6 is arista.avd.defined(true) %}
{%             do encapsulations_list.append('ipv4') %}
{%             do encapsulations_list.append('ipv6') %}
{%             if flow_tracking.sampled.encapsulation.mpls is arista.avd.defined(true) %}
{%                 do encapsulations_list.append('mpls') %}
{%             endif %}
{%         endif %}
{%         set encapsulations = (encapsulations_list or ["-"]) | join(", ") %}
{%         if flow_tracking.sampled.hardware_offload.ipv4 is arista.avd.defined(true) %}
{%             set hardware_offload_ipv4 = 'enabled' %}
{%         endif %}
{%         if flow_tracking.sampled.hardware_offload.ipv6 is arista.avd.defined(true) %}
{%             set hardware_offload_ipv6 = 'enabled' %}
{%         endif %}
| {{ sample_size }} | {{ min_sample_size }} | {{ hardware_offload_ipv4 }} | {{ hardware_offload_ipv6 }} | {{ encapsulations }} |
{%         if flow_tracking.sampled.trackers is arista.avd.defined %}

##### Trackers Summary

| Tracker Name | Record Export On Inactive Timeout | Record Export On Interval | MPLS | Number of Exporters | Applied On | Table Size |
| ------------ | --------------------------------- | ------------------------- | ---- | ------------------- | ---------- | ---------- |
{%             for tracker in flow_tracking.sampled.trackers | arista.avd.natural_sort('name') %}
{%                 set on_inactive_timeout = tracker.record_export.on_inactive_timeout | arista.avd.default("-") %}
{%                 set on_interval = tracker.record_export.on_interval | arista.avd.default("-") %}
{%                 set mpls = tracker.record_export.mpls | arista.avd.default("-") %}
{%                 set count_exporter = tracker.exporters | arista.avd.default([]) | length %}
{%                 set applied_on = [] %}
{%                 set table_size = tracker.table_size | arista.avd.default('-') %}
{%                 for dps_interface in dps_interfaces | arista.avd.default([]) %}
{%                     if dps_interface.flow_tracker.sampled is arista.avd.defined(tracker.name) %}
{%                         do applied_on.append(dps_interface.name) %}
{%                     endif %}
{%                 endfor %}
{%                 for ethernet_interface in ethernet_interfaces | arista.avd.default([]) %}
{%                     if ethernet_interface.flow_tracker.sampled is arista.avd.defined(tracker.name) %}
{%                         do applied_on.append(ethernet_interface.name) %}
{%                     endif %}
{%                 endfor %}
{%                 for port_channel_interface in port_channel_interfaces | arista.avd.default([]) %}
{%                     if port_channel_interface.flow_tracker.sampled is arista.avd.defined(tracker.name) %}
{%                         do applied_on.append(port_channel_interface.name) %}
{%                     endif %}
{%                 endfor %}
| {{ tracker.name }} | {{ on_inactive_timeout }} | {{ on_interval }} | {{ mpls }} | {{ count_exporter }} | {{ applied_on | join("<br>") }} | {{ table_size }} |
{%             endfor %}

##### Exporters Summary

| Tracker Name | Exporter Name | Collector IP/Host | Collector Port | Local Interface |
| ------------ | ------------- | ----------------- | -------------- | --------------- |
{%             for tracker in flow_tracking.sampled.trackers | arista.avd.natural_sort('name') %}
{%                 for exporter in tracker.exporters | arista.avd.natural_sort('name') %}
{%                     if exporter.collectors is arista.avd.defined %}
{%                         set host = exporter.collectors | arista.avd.natural_sort | map(attribute='host') | list | join('<br>') %}
{%                         set port = exporter.collectors | arista.avd.natural_sort | map(attribute='port') | map('arista.avd.default', '-') | list | join('<br>') %}
{%                     elif exporter.collector.host is arista.avd.defined %}
{%                         set host = exporter.collector.host %}
{%                         set port = exporter.collector.port | arista.avd.default("-") %}
{%                     endif %}
{%                     set local_interface = exporter.local_interface | arista.avd.default("No local interface") %}
| {{ tracker.name }} | {{ exporter.name }} | {{ host | arista.avd.default("-") }} | {{ port | arista.avd.default("-") }} | {{ local_interface }} |
{%                 endfor %}
{%             endfor %}
{%         endif %}
{%     endif %}
{%     if flow_tracking.hardware is arista.avd.defined %}

#### Flow Tracking Hardware
{%         if flow_tracking.hardware.record.format_ipfix_standard_timestamps_counters is arista.avd.defined(true) %}

Software export of IPFIX data records enabled.
{%         endif %}
{%         if flow_tracking.hardware.trackers is arista.avd.defined %}

##### Trackers Summary

| Tracker Name | Record Export On Inactive Timeout | Record Export On Interval | Number of Exporters | Applied On |
| ------------ | --------------------------------- | ------------------------- | ------------------- | ---------- |
{%             for tracker in flow_tracking.hardware.trackers | arista.avd.natural_sort('name') %}
{%                 set on_inactive_timeout = tracker.record_export.on_inactive_timeout | arista.avd.default("-") %}
{%                 set on_interval = tracker.record_export.on_interval | arista.avd.default("-") %}
{%                 set count_exporter = tracker.exporters | arista.avd.default([]) | length %}
{%                 set applied_on = [] %}
{%                 for dps_interface in dps_interfaces | arista.avd.default([]) %}
{%                     if dps_interface.flow_tracker.hardware is arista.avd.defined(tracker.name) %}
{%                         do applied_on.append(dps_interface.name) %}
{%                     endif %}
{%                 endfor %}
{%                 for ethernet_interface in ethernet_interfaces | arista.avd.default([]) %}
{%                     if ethernet_interface.flow_tracker.hardware is arista.avd.defined(tracker.name) %}
{%                         do applied_on.append(ethernet_interface.name) %}
{%                     endif %}
{%                 endfor %}
{%                 for port_channel_interface in port_channel_interfaces | arista.avd.default([]) %}
{%                     if port_channel_interface.flow_tracker.hardware is arista.avd.defined(tracker.name) %}
{%                         do applied_on.append(port_channel_interface.name) %}
{%                     endif %}
{%                 endfor %}
| {{ tracker.name }} | {{ on_inactive_timeout }} | {{ on_interval }} | {{ count_exporter }} | {{ applied_on | join("<br>") }} |
{%             endfor %}

##### Exporters Summary

| Tracker Name | Exporter Name | Collector IP/Host | Collector Port | Local Interface |
| ------------ | ------------- | ----------------- | -------------- | --------------- |
{%             for tracker in flow_tracking.hardware.trackers | arista.avd.natural_sort('name') %}
{%                 for exporter in tracker.exporters | arista.avd.natural_sort('name') %}
{%                     if exporter.collectors is arista.avd.defined %}
{%                         set host = exporter.collectors | arista.avd.natural_sort | map(attribute='host') | list | join('<br>') %}
{%                         set port = exporter.collectors | arista.avd.natural_sort | map(attribute='port') | map('arista.avd.default', '-') | list | join('<br>') %}
{%                     elif exporter.collector.host is arista.avd.defined %}
{%                         set host = exporter.collector.host %}
{%                         set port = exporter.collector.port | arista.avd.default("-") %}
{%                     endif %}
{%                     set local_interface = exporter.local_interface | arista.avd.default("No local interface") %}
| {{ tracker.name }} | {{ exporter.name }} | {{ host | arista.avd.default("-") }} | {{ port | arista.avd.default("-") }} | {{ local_interface }} |
{%                 endfor %}
{%             endfor %}
{%         endif %}
{%     endif %}
{%     if flow_tracking.mirror_on_drop is arista.avd.defined %}

#### Flow Tracking mirror-on-drop

| Sample Limit Size | Encapsulations |
| ----------------- | -------------- |
{%         set sample_limit_size = flow_tracking.mirror_on_drop.sample_limit | arista.avd.default("default") %}
{%         set encapsulations_list = [] %}
{%         if flow_tracking.mirror_on_drop.encapsulation.ipv4_ipv6 is arista.avd.defined(true) %}
{%             do encapsulations_list.append('ipv4, ipv6') %}
{%         endif %}
{%         if flow_tracking.mirror_on_drop.encapsulation.mpls is arista.avd.defined(true) %}
{%             do encapsulations_list.append('mpls') %}
{%         endif %}
{%         set encapsulations = (encapsulations_list or ["-"]) | join(", ") %}
| {{ sample_limit_size }} | {{ encapsulations }} |
{%         if flow_tracking.mirror_on_drop.trackers is arista.avd.defined %}
{%             set ns_count_exporter = namespace(count_exporter = 0) %}

##### Trackers Summary

{# Note: Add the Applied On Interface column similar to sample and hardware once support is available under ethernet_interface/port_channel_interface/dps_interfaces #}
| Tracker Name | Record Export On Inactive Timeout | Record Export On Interval | Number of Exporters |
| ------------ | --------------------------------- | ------------------------- | ------------------- |
{%             for tracker in flow_tracking.mirror_on_drop.trackers | arista.avd.natural_sort('name') %}
{%                 set on_inactive_timeout = tracker.record_export.on_inactive_timeout | arista.avd.default("-") %}
{%                 set on_interval = tracker.record_export.on_interval | arista.avd.default("-") %}
{%                 set ns_count_exporter.count_exporter = tracker.exporters | arista.avd.default([]) | length %}
| {{ tracker.name }} | {{ on_inactive_timeout }} | {{ on_interval }} | {{ ns_count_exporter.count_exporter }} |
{%             endfor %}
{%             if ns_count_exporter.count_exporter > 0 %}

##### Exporters Summary

| Tracker Name | Exporter Name |  Local Interface | Template Interval | Collector IP/Host/Sflow | Collector Port | DSCP Value | Format |
| ------------ | ------------- | ---------------- | ------------------| ----------------------- | -------------- | ---------- | ------ |
{%                 for tracker in flow_tracking.mirror_on_drop.trackers | arista.avd.natural_sort('name') %}
{%                     for exporter in tracker.exporters | arista.avd.natural_sort('name') %}
{%                         set current_exporter_collector_hosts = exporter.collectors | arista.avd.natural_sort | map(attribute='host') | list %}
{%                         set current_exporter_collector_ports = exporter.collectors | arista.avd.natural_sort | map(attribute='port') | map('arista.avd.default', '-') | list %}
| {{ tracker.name }} | {{ exporter.name }} | {{ exporter.local_interface | arista.avd.default("-") }} | {{ exporter.template_interval | arista.avd.default("-") }} | {{ current_exporter_collector_hosts | join('<br>') }} | {{ current_exporter_collector_ports | join('<br>') }} | {{ exporter.dscp | arista.avd.default("-") }} | {{ exporter.format | arista.avd.default("-") }} |
{%                     endfor %}
{%                 endfor %}
{%             endif %}
{%         endif %}
{%     endif %}

#### Flow Tracking Device Configuration

```eos
{%     include 'eos/flow-tracking.j2' %}
```
{% endif %}
